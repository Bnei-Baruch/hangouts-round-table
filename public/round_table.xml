<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <!-- Licensed under the Apache License, Version 2.0 (the "License"); you may not
   * use this file except in compliance with the License. You may obtain a copy of
   * the License at
   *
   * http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
   * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
   * License for the specific language governing permissions and limitations under
   * the License
  -->
  <ModulePrefs title="Hangout Starter">
    <Require feature="rpc" />
    <Require feature="views" />
    <Require feature="locked-domain" />
  </ModulePrefs>
  <Content type="html"><![CDATA[

<html>
<style type="text/css">
<!--
.button {
  border-radius: 3px;
  -moz-border-radius: 3px;
  background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#ddd));
  background: -moz-linear-gradient(top, #fff, #ddd);
  border: 1px solid #bbb;
}

.button:active {
        background: -webkit-gradient(linear, left top, left bottom, from(#aaa), to(#333));
        background: -moz-linear-gradient(bottom, #ddd, #aaa); }

-->
</style>
<body>

<script src="https://hangoutsapi.talkgadget.google.com/hangouts/api/hangout.js?v=1.0" ></script>

<!-- load JQuery -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>

<script src="http://bbworkshop.kbb1.com/public/conf.js"></script>
<script src="http://bbworkshop.kbb1.com/public/app.js"></script>

<button id="show_participants" style="visibility:hidden;">Show Participants!</button><br>
<div id="participants_div">?</div><br>
<button id="update_server_button">Update server</button><br>
<button id="set_button">SET</button>
Key:<input id="set_key_box" type="text"/> Value:<input id="set_value_box" type="text"/><br>
<button id="get_button">GET</button>

<div id="webdis"><div>

<script type="text/javascript">
function show_participants() {
  $("#participants_div").html(JSON.stringify(gapi.hangout.getParticipants()));
}

function set() {
  set_key($("#set_key_box")[0].value,
          $("#set_value_box")[0].value,
	  function(data) {
            $("#webdis").append("<div>" + JSON.stringify(data) + "</div>");
          });
}

function get() {
  get_key($("#set_key_box")[0].value,
          function(data) {
            $("#webdis").append("<div>" + JSON.stringify(data) + "</div>");
         });
}

function update_server() {
  var key = encodeURIComponent(gapi.hangout.getHangoutUrl());
  var value = new Object();
  value.lang = "en";
  value.url = key;
  value.timestamp = Date.now();
  value.paritipants = new Array();
  var participants = gapi.hangout.getParticipants();
  for (var index in participants) {
    var participant = participants[index];
    if (participant.person) {
      value.paritipants.push(participant.person.displayName);
    }
  }
  set_key(key, JSON.stringify(value));
}

function init() {
  // When API is ready...
  gapi.hangout.onApiReady.add(
      function(eventObj) {
        if (eventObj.isApiReady) {
          $("#set_button").click(set);
          $("#get_button").click(get);
          $("#show_participants").click(show_participants);
          $('#show_participants').css("visibility","visible");
          $("#update_server_button").click(update_server);
        }
      });
}

// Wait for gadget to load.
gadgets.util.registerOnLoadHandler(init);
</script>
</body>
]]>
  </Content>
</Module>
