<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <!-- Licensed under the Apache License, Version 2.0 (the "License"); you may not
   * use this file except in compliance with the License. You may obtain a copy of
   * the License at
   *
   * http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
   * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
   * License for the specific language governing permissions and limitations under
   * the License
  -->
  <ModulePrefs title="Hangout Starter">
    <Require feature="rpc" />
    <Require feature="views" />
    <Require feature="locked-domain" />
  </ModulePrefs>
  <Content type="html"><![CDATA[

<html>
<style type="text/css">
<!--
.button {
  border-radius: 3px;
  -moz-border-radius: 3px;
  background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#ddd));
  background: -moz-linear-gradient(top, #fff, #ddd);
  border: 1px solid #bbb;
}

.button:active {
        background: -webkit-gradient(linear, left top, left bottom, from(#aaa), to(#333));
        background: -moz-linear-gradient(bottom, #ddd, #aaa); }

-->
</style>
<body>

<script src="https://hangoutsapi.talkgadget.google.com/hangouts/api/hangout.js?v=1.3" ></script>

<!-- load JQuery -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>

<script src="https://bbworkshop.kbb1.com/conf.js"></script>
<script src="https://bbworkshop.kbb1.com/app.js"></script>

<button id="show_participants" style="visibility:hidden;">Show Participants!</button><br>
<div id="participants_div">?</div><br>
<button id="update_server_button">Update server</button><br>
<button id="set_button">SET</button>
Key:<input id="set_key_box" type="text"/> Value:<input id="set_value_box" type="text"/><br>
<button id="get_button">GET</button>

<div id="webdis"><div>

<script type="text/javascript">
function show_participants() {
  $("#participants_div").html(JSON.stringify(gapi.hangout.getParticipants()));
}

function set() {
  set_key($("#set_key_box")[0].value,
          $("#set_value_box")[0].value,
	  function(data) {
            $("#webdis").html("<div>" + JSON.stringify(data) + "</div><div>" + Date.now() + "</div>");
          });
}

function get() {
  get_key($("#set_key_box")[0].value,
          function(data) {
            $("#webdis").html("<div>" + JSON.stringify(data) + "</div><div>" + Date.now() + "</div>");
         });
}

function update_server() {
  get_timestamp(function(time_now) {
    var value = new Object();
    var url_arr = gapi.hangout.getHangoutUrl().split("/");
    value.id = url_arr[url_arr.length - 1];
    value.lang = "en";
    value.timestamp = time_now;
    value.participants = new Array();
    var participants = gapi.hangout.getParticipants();
    for (var index in participants) {
      var participant = participants[index];
      if (participant.person) {
        value.participants.push(participant.person.displayName);
      }
    }
    set_key("table_" + value.id, JSON.stringify(value),
            function(data) {
              $("#webdis").html("<div>" + JSON.stringify(data) + "</div><div>" + Date.now() + "</div>");
           });
  });
}

function only_one_update() {
  var participants = gapi.hangout.getEnabledParticipants();
  var local_participant_id = gapi.hangout.getLocalParticipantId();
  var should_update = true;
  for (var index in participants) {
    var participant = participants[index];
    if (participant.id < local_participant_id) {
      should_update = false;
      break;
    } 
  }
  if (should_update) {
    update_server();
  }
}

function init() {
  gapi.hangout.hideApp();
  // When API is ready...
  gapi.hangout.onApiReady.add(
      function(eventObj) {
        if (eventObj.isApiReady) {
          $("#set_button").click(set);
          $("#get_button").click(get);
          $("#show_participants").click(show_participants);
          $('#show_participants').css("visibility","visible");
          $("#update_server_button").click(update_server);
          // Periodically update server (only one person from each hangout).
          setInterval(only_one_update, conf.hangout_upadate_timeout);
        }
      });
}

// Wait for gadget to load.
gadgets.util.registerOnLoadHandler(init);
</script>
</body>
]]>
  </Content>
</Module>
