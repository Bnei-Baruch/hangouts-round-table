<html>
<head>
  <!-- load JQuery -->
  <script type="text/javascript" src="jquery-1.8.3.min.js"></script>
  <script type="text/javascript" src="jquery.ba-bbq.js"></script>
  <script type="text/javascript" src="jquery-url.js"></script>
  <!-- Fix $.ajax for IE8,9 -->
  <script type="text/javascript" src="jquery.xdomainrequest.js"></script>
  <!-- Assumes conf.js is in the same place as index.html -->
  <script src="conf.js"></script>
  <script src="app.js"></script>
  <script type="text/javascript">
    function get_label_prefix() {
      var label_prefix = $.url('?label_prefix')
      if (!label_prefix) {
        label_prefix = 'talk_';
      }
      return label_prefix
    }
    function update_room_value() {
      var onair = $.url('?onair');
      if (onair && !(onair in {'false':true, 'no':true, '0':true})) {
        onair = "&onair=true";
      } else {
        onair = "";
      }
      $("#talk")[0].href = "//" + conf.host + "/user.html?label=" + get_label_prefix() + $("#room").val() + onair + "&create_if_not_exists=true"; 
    }
    $(function() {
      var prefix = $.url('?prefix');
      if (prefix) {
        $("#prefix").text(decodeURIComponent(prefix));
      }
      var link_text = $.url('?link_text');
      if (link_text) {
        $('#talk').text(decodeURIComponent(link_text));
      }
      var room_value = $.url('?default_room');
      if (room_value) {
        $('#room')[0].value = decodeURIComponent(room_value);
      }
      update_room_value();
    });

    function update_msg() {
      get_free_table(get_label_prefix() + "*", function(one_table) {
        if (one_table) {
          $("#msg").html(one_table.participants.length);
        } else {
          $("#msg").html("0");
        } 
      });
    }
    function view() {
      update_msg();
      setInterval(update_msg, conf.button_update_interval);
    }
    $(function() {
      var enable_participants = $.url('?enable_participants');
      if (enable_participants && !(enable_participants in {'no':true, 'false':true, '0':true})) {
        $('#participants')[0].style.visibility = 'visible';
        view();
      }
    });
    $(function() {
      $("#room").change(function() { update_room_value(); });
    });
  </script> 
</head>
<body>
<span id="prefix">Room:</span><input id="room" type="text" name="room" value="hafaza" size="8">
<a id="talk" target="_blank">Talk</a>
<span id="participants" style="visibility:hidden">Total participants: <span id="msg"></span></span>
</body>
</html>

